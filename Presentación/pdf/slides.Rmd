---
title: "CRONOS-2 Wave 4 — Presentación"
author: "Nil Portolés"
date: "`r format(Sys.Date(), '%d %B %Y')`"
output:
  ioslides_presentation:
    widescreen: true
    fig_width: 7
    fig_height: 4.5
    smaller: true
  slidy_presentation: default
  beamer_presentation: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r}
knitr::opts_chunk$set(
  echo = FALSE, message = FALSE, warning = FALSE,
  fig.width = 7, fig.height = 4.5
)
suppressPackageStartupMessages({
  library(tidyverse)
  library(kableExtra)
})
```
---
```{r}
datos <- readRDS("cron2_w4_clean.rds")

wmean <- function(x, w, na.rm = TRUE){
  ok <- is.finite(x) & is.finite(w)
  if (!any(ok)) return(NA_real_)
  x <- x[ok]; w <- w[ok]
  sw <- sum(w); if (!is.finite(sw) || sw <= 0) return(mean(x, na.rm = TRUE))
  sum(x * w) / sw
}

```
---
---
```{r}
glob_pa <- wmean(datos$positive_affect_mean, datos$c2weight)
glob_di <- wmean(datos$distress_mean,        datos$c2weight)
```
---
---
```{r}
tab_country <- datos %>%
  group_by(cntry_iso2) %>%
  summarise(
    `Afecto positivo` = wmean(positive_affect_mean, c2weight),
    `Distrés`         = wmean(distress_mean,        c2weight),
    n = n(),
    .groups = "drop"
  ) %>%
  mutate(across(c(`Afecto positivo`,`Distrés`), ~round(.x, 2))) %>%
  arrange(desc(`Distrés`))

kable(tab_country, "html") %>%
  kable_styling(full_width = TRUE)
```
---

---
```{r}
plot_df <- datos %>%
  group_by(cntry_iso2) %>%
  summarise(media = wmean(distress_mean, c2weight), .groups="drop") %>%
  arrange(media)

ggplot(plot_df, aes(x = reorder(cntry_iso2, media), y = media)) +
  geom_col() +
  coord_flip() +
  labs(x = "País", y = "Distrés (media ponderada 1–4)")
```
---

---
```{r}
plot_df <- datos %>%
  group_by(cntry_iso2) %>%
  summarise(media = wmean(positive_affect_mean, c2weight), .groups="drop") %>%
  arrange(media)

ggplot(plot_df, aes(x = reorder(cntry_iso2, media), y = media)) +
  geom_col() +
  coord_flip() +
  labs(x = "País", y = "Afecto positivo (media ponderada 1–4)")
```
---

---
```{r}
sex_df <- datos %>%
  filter(!is.na(gndr_lab)) %>%
  group_by(gndr_lab) %>%
  summarise(
    `Afecto positivo` = wmean(positive_affect_mean, c2weight),
    `Distrés`         = wmean(distress_mean,        c2weight),
    .groups = "drop"
  ) %>%
  tidyr::pivot_longer(c(`Afecto positivo`,`Distrés`),
                      names_to = "Indicador", values_to = "Media")

ggplot(sex_df, aes(x = gndr_lab, y = Media, fill = Indicador)) +
  geom_col(position = position_dodge(0.7), width = 0.65) +
  labs(x = "Sexo", y = "Media ponderada (1–4)") +
  coord_cartesian(ylim = c(1,4))
```
---

---
```{r}
sex_summ <- datos %>%
  filter(!is.na(gndr_lab)) %>%
  group_by(gndr_lab) %>%
  summarise(
    PA = wmean(positive_affect_mean, c2weight),
    DI = wmean(distress_mean,        c2weight),
    .groups="drop"
  ) %>% tidyr::pivot_wider(names_from = gndr_lab, values_from = c(PA, DI))
gap_di <- sex_summ$DI_Female - sex_summ$DI_Male
```
---

---
```{r}
age_df <- datos %>%
  filter(!is.na(age_band)) %>%
  group_by(age_band) %>%
  summarise(
    `Afecto positivo` = wmean(positive_affect_mean, c2weight),
    `Distrés`         = wmean(distress_mean,        c2weight),
    .groups = "drop"
  ) %>%
  tidyr::pivot_longer(c(`Afecto positivo`,`Distrés`),
                      names_to = "Indicador", values_to = "Media")

ggplot(age_df, aes(x = age_band, y = Media, fill = Indicador)) +
  geom_col(position = position_dodge(0.7), width = 0.65) +
  labs(x = "Edad", y = "Media ponderada (1–4)") +
  coord_cartesian(ylim = c(1,4))
```
---

---
```{r}
age_di <- datos %>%
  filter(!is.na(age_band)) %>%
  group_by(age_band) %>%
  summarise(DI = wmean(distress_mean, c2weight), .groups="drop") %>%
  arrange(DI)
young_grp <- as.character(age_di$age_band[1]);   young_val <- age_di$DI[1]
old_grp   <- as.character(age_di$age_band[nrow(age_di)]); old_val <- age_di$DI[nrow(age_di)]

```
---


